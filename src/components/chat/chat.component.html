@if (scientist(); as currentScientist) {
  <div class="flex h-screen">
    <!-- Left Column: Scientist Showcase -->
    <div class="hidden md:flex flex-col w-1/3 bg-black/30 p-8 border-r border-amber-600/30">
      <div class="flex-grow flex flex-col items-center justify-center text-center">
        <img [src]="currentScientist.image" [alt]="currentScientist.name" class="w-48 h-48 rounded-full object-cover border-4 border-amber-400 shadow-lg shadow-amber-500/20" [style.object-position]="currentScientist.imagePosition || 'top'">
        <h2 class="font-display text-4xl font-bold text-amber-100 mt-6">{{ currentScientist.name }}</h2>
        <p class="text-amber-200/80 mt-2">{{ currentScientist.discoveries }}</p>
      </div>
      <button (click)="goBack()" class="mt-8 mx-auto flex items-center gap-2 text-amber-300 hover:text-amber-100 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Gallery
      </button>
    </div>

    <!-- Right Column: Chat Area -->
    <div class="flex flex-col w-full md:w-2/3 h-screen">
      <!-- Mobile Header -->
      <header class="flex md:hidden items-center p-4 border-b border-amber-600/30">
        <button (click)="goBack()" class="mr-4 text-amber-300 hover:text-amber-100 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <img [src]="currentScientist.image" [alt]="currentScientist.name" class="w-12 h-12 rounded-full object-cover border-2 border-amber-400" [style.object-position]="currentScientist.imagePosition || 'top'">
        <div class="ml-3">
          <h2 class="font-display text-xl font-bold text-amber-100">{{ currentScientist.name }}</h2>
        </div>
      </header>

      <!-- Chat Messages -->
      <div #chatContainer class="flex-grow overflow-y-auto p-6 space-y-6">
        @for (message of chatHistory(); track $index) {
          <div class="flex" [class.justify-end]="message.sender === 'user'">
            <div class="flex items-start gap-3 max-w-xl">
               @if (message.sender === 'ai') {
                  <img [src]="currentScientist.image" [alt]="currentScientist.name" class="w-10 h-10 rounded-full object-cover self-start hidden sm:block" [style.object-position]="currentScientist.imagePosition || 'top'">
               }
              <div 
                class="rounded-2xl p-4"
                [class.bg-amber-800/80]="message.sender === 'user'"
                [class.bg-gray-700/80]="message.sender === 'ai'"
                [class.rounded-br-none]="message.sender === 'user'"
                [class.rounded-bl-none]="message.sender === 'ai'">
                
                @if (message.text === '...') {
                  <div class="flex space-x-1">
                    <span class="w-2 h-2 bg-gray-300 rounded-full animate-pulse [animation-delay:-0.3s]"></span>
                    <span class="w-2 h-2 bg-gray-300 rounded-full animate-pulse [animation-delay:-0.15s]"></span>
                    <span class="w-2 h-2 bg-gray-300 rounded-full animate-pulse"></span>
                  </div>
                } @else {
                  <p class="text-white whitespace-pre-wrap">{{ message.text }}</p>
                }
                
                @if (message.sender === 'ai' && message.text !== '...') {
                  <div class="mt-3 pt-2 border-t border-white/10 flex items-center gap-4">
                    <button (click)="generateAudio(message.text, $index)" title="Generate Audio" class="text-amber-300 hover:text-amber-100 transition-colors">
                      @if (audioPlayingIndex() === $index && !isAudioPaused()) {
                        <!-- Pause Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M5 5a1 1 0 011-1h2a1 1 0 011 1v10a1 1 0 01-1 1H6a1 1 0 01-1-1V5zm8-1a1 1 0 00-1 1v10a1 1 0 001 1h2a1 1 0 001-1V5a1 1 0 00-1-1h-2z" clip-rule="evenodd" />
                        </svg>
                      } @else {
                        <!-- Play Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" />
                        </svg>
                      }
                    </button>
                  </div>

                  @if (message.videoStatus !== 'idle') {
                    <div class="mt-3 space-y-2">
                        @if (message.videoStatus === 'generating') {
                            <p class="text-xs text-amber-200 animate-pulse">Generating video... this may take a few minutes.</p>
                        }
                        @if (message.videoPrompt) {
                            <div class="p-3 bg-black/20 rounded-lg border border-white/10">
                                <p class="text-xs text-amber-100/70">
                                    <span class="font-semibold text-amber-200">
                                        @switch (message.videoStatus) {
                                            @case ('generating') { Prompt: }
                                            @case ('done') { Prompt used: }
                                            @case ('error') { Attempted prompt: }
                                        }
                                    </span>
                                    "{{ message.videoPrompt }}"
                                </p>
                            </div>
                        }
                        @if (message.videoStatus === 'done' && message.videoUrl) {
                            <video [src]="message.videoUrl" controls autoplay class="w-full rounded-lg"></video>
                        }
                        @if (message.videoStatus === 'error') {
                            <p class="text-xs text-red-400">Error: {{ message.errorMessage }}</p>
                        }
                    </div>
                  }
                }
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Input Form -->
      <footer class="p-4 border-t border-amber-600/30">
        <form (ngSubmit)="sendMessage()" class="flex items-center gap-2">
          <input 
            type="text" 
            [(ngModel)]="newMessage"
            name="newMessage"
            placeholder="Ask your question..." 
            class="flex-grow bg-gray-800/50 border-2 border-amber-600/50 rounded-full py-3 px-5 text-base text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400 transition-all duration-300"
            [disabled]="isLoading()"
          />
          <button 
            type="submit" 
            class="bg-amber-600 hover:bg-amber-500 rounded-full p-3 text-white disabled:bg-gray-500 transition-colors"
            [disabled]="isLoading() || !newMessage().trim()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" />
            </svg>
          </button>
        </form>
      </footer>
    </div>
  </div>
}